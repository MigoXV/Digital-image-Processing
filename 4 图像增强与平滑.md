# 4 图像增强与平滑

## 4.1 引言

通过一些运算来突出图像的某些信息,如轮廓等.但通过运算的图像不一定逼近原图像.
图像增强:
空间域法
$$
g(x,y)=h(x,y)*f(x,y)
$$
频域法

图

## 4.2 直方图

### 4.2.1 直方图的基本概念

如果将图像中像素亮度（灰度级别）看成是一个随机变量， 则其分布情况就反映了图像的统计特性，这可用Probability Density Function (**PDF**) 来刻画和描述 ， 表现为灰度直方图 （Histogram）。灰度直方图是灰度级的函数，它表示图像中具 有某种灰度级的像素的个数，反映了图像中每种灰度出现的频率， 如图4-1所示。灰度直方图的横坐标是灰度级，纵坐标是该灰度 级出现的频度，它是图像最基本的统计特征。

图4-1

<font color="pink">考题：灰度直方图的计算公式</font>

- mean：平均值
- MSE:？？？

设r代表图像中像素灰度级，作归一化处理后，r将被限定在 ［0, 1］之内。在灰度级中，r=0代表黑，r=1代表白。对于一幅 给定的图像来说，每一个像素取得［0, 1］区间内的灰度级是随 机的，也就是说r是一个随机变量。假定对每一瞬间，它们是连 续的随机变量，那么就可以用概率密度函数pr (r)来表示原始图像 的灰度分布。如果用直角坐标系的横轴代表灰度级r，用纵轴代 表灰度级的概率密度函数$p_r (r)$，这样就可以针对一幅图像在这个 坐标系中作出一条曲线来。这条曲线在概率论中就是概率密度 曲线，如图4-2所示。



图4-2 图像灰度分布概率密度函数

图：灰度值的曲线（仅供了解）



从图像灰度级的分布可以看出一幅图像的灰度分布特性。例如，从图4-2中的(a)和(b)两个灰度分布概率密度函数中可以看出： (a)的大多数像素灰度值取在较暗的区域，所以这幅图像肯定较 暗，一般在摄影过程中曝光过强就会造成这种结果；(b)图像的 像素灰度值集中在亮区，因此，图像(b)将偏亮，一般在摄影中 曝光太弱将导致这种结果。当然，从两幅图像的灰度分布来看 图像的质量均不理想。

### 4.1.2 直方图的性质

（1） 直方图是一幅图像中各像素灰度值出现次数（或频数） 的统计结果，它只反映该图像中不同灰度值出现的次数（或频数），而未反映某一灰度值像素所在位置。也就是说，它只包含了该图像中某一灰度值的像素出现的概率，而丢失了其所在位置 的信息。 

（2）任一幅图像，都能惟一地确定出一幅与它对应的直方图， 但不同的图像，可能有相同的直方图。也就是说，图像与直方图 之间是**多对一**的映射关系。如图4-3就是一个不同图像具有相同直方图的例子。

（3） 由于直方图是对具有相同灰度值的像素统计得到的， 因此，一幅图像各子区的直方图之和就等于该图像全图的直方 图，如图4-4所示。

- 可以产生边界线

图4-3 图像与直方图间的多对一关系

图4-4 直方图的分解

### 4.1.3 直方图的计算

灰度直方图的计算非常简单，依据定义，在离散形式下， 用 $r_k$代表离散灰度级，用$p_r (r_k )$代表pr (r)，并且有下式成立：
$$
p_r\left(r_k\right)=\frac{n_k}{n} \quad 0 \leq r_k \leq 1 \quad k=0,1,2, \Lambda, l-1
$$
式中：nk为图像中出现rk级灰度的像素数，n是图像像素总数，而 nk /n即为频数。在直角坐标系中做出rk与pr (rk )的关系图形，即称为 该图像的直方图。设若图像具有L级灰度（通常L=256，即8位灰 度级），则大小为M×N的灰度图像f(x, y) 的灰度直方图pBuffer ［0…L-1］可用如下算法得到：

（1） 初始化：pBuffer［k］=0 ; k=0, …, L-1。 

（2） 统计：pBuffer［f(x, y)］++ ; x, y =0, …, M-1, 0, …, N-1。 

（3） 归一化：pBuffer［f(x, y)］/=M*N。 

其中，直方图的归一化是一个可选项， 若不需要特殊处理可以 不进行此项操作。 图4-5和图4-6分别是Lena图像、 钟楼图像与其对应的直方 图。

图4-5 Lena图像及直方图

### 4.1.4 直方图的拉伸

> 感兴趣的部分增强，不敢行

如上所述，一幅给定图像的灰度级分布在0≤r≤1范围内。可 以对［0, 1］区间内的任一个r值进行如下变换：
$$
s=T(r)
$$
也就是说，通过上述变换，每个原始图像的像素灰度值r都对应 产生一个s值。变换函数T(r)应满足下列条件：

- 在 $0 \leq r \leq 1$ 区间内, $T(r)$ 值单调增加;
- 对于 $0 \leq r \leq 1$, 有 $0 \leq T(r) \leq 1$ 。

因为 $s=T(r)$ 是单调增加的, 由数学分析可知, 它的反函数 $r=T^{-1}(s)$ 也是单调函数。在这种情况下, 如图4-8所示, $\eta<s$ 且仅 当 $\xi<r$ 时发生, 所以可以求得随机变量 $\eta$ 的分布函数为
$$
F_\eta(s)=p(\eta<s)=p[\xi<r]=\int_{-\infty}^r p_r(x) d x
$$
对式(4-4)两边求导, 即可得到随机变量 $\eta$ 的分布密度函数 $p_{\mathrm{s}}(s)$ 为
$$
p_s(s)=p_r(r) \cdot \frac{d}{d s}\left[T^{-1}(s)\right]=\left[p_r(r) \cdot \frac{d r}{d s}\right]_{r=T^{-1}(s)}
$$
通过变换函数T(r)可以控制图像灰度级的概率密度函数，从而改 变图像的灰度层次。这就是直方图修改技术的理论基础。

图4-7 灰度拉伸变换函数

图4-8 r和s 的变换函数关系

### 4.1.5 直方图均衡（重点，又称均衡拉伸算法）

直方图均衡化处理是以累积分布函数变换法为基础的直方 图修正法。假定变换函数为
$$
s=T(r)=\int_0^r p_r(\omega) d \omega
$$
式中: $\omega$ 是积分变量, 而 $\int_0^r p_r(\omega) d \omega$ 就是 $r$ 的累积分布函数。
这里, 累积分布函数是 $r$ 的函数, 并且单调地从 0 增加到 1 , 所以这个变换函数满足关于 $T(r)$ 在 $0 \leq r \leq 1$ 内单值单调增加。在 $0 \leq r \leq 1$ 内有 $0 \leq T(r) \leq 1$ 的两个条件。

对式中的 $r$ 求导, 则

$$
\frac{d s}{d r}=p_r(r)
$$

再把结果代入(4-5)式有

$$
\begin{aligned}
p_s(s) & =\left[p_r(r) \cdot \frac{d r}{d s}\right]_{r=T^{-1}(s)}=\left[p_r(r) \cdot \frac{1}{d s / d r}\right]_{r=T^{-1}(s)} \\
& =\left[p_r(r) \cdot \frac{1}{p_r(r)}\right]=1
\end{aligned}
$$
由上面的推导可见，在变换后的变量s的定义域内的概率密 度是均匀分布的。因此，用r的累积分布函数作为变换函数，可 产生一幅灰度级分布具有均匀概率密度的图像。其结果扩展了 像素取值的动态范围。 

例如，在图4-9中，(a)是原始图像的概率密度函数。从图中 可知，该图像的灰度集中在较暗的区域，是一幅曝光过强的照 片。由图(a)可知， 原始图像的概率密度函数为
$$
p_r(r)= \begin{cases}-2 r+2 & 0 \leq r \leq 1 \\ 0 & \text { 其他 }\end{cases}
$$
用累积分布函数原理求变换函数
$$
s=T(r)=\int_0^r p_r(\omega) d \omega=\int_0^r(-2 \omega+2) d \omega=-r^2+2 r
$$
变换后的s值与r值的关系为
$$
s=-r^2+2 r=T(r)
$$
按照这样的关系变换，就可以得到一幅改善质量的新图像。这 幅图像的灰度层次将不再是呈现较暗色调的图像，而是一幅灰 度层次较为适中， 比原始图像清晰， 明快得多的图像。可以证 明，变换后的灰度及概率密度是均匀分布的。图4-9(b)和(c)分别 为变换函数和变换后的均匀的概率密度函数。

图4-9 直方图变换法

上述方法是以连续随机变量为基础进行讨论的。当灰度级是 离散值时，可用频数近似代替概率值，即
$$
p_r\left(r_k\right)=\frac{n_k}{n} \quad 0 \leq r_k \leq 1 \quad k=0,1, \Lambda, l-1
$$
式中: $l$ 是灰度级的总数目, $p_r\left(r_k\right)$ 是取第 $k$ 级灰度值的概率, $n_k$ 是图像中出现第 $\mathrm{k}$ 级灰度的次数, $n$ 是图像中像素总数。

式(4-6)的离散形式可由式(4-10)表示：
$$
s_k=T\left(r_k\right)=\sum_{j=0}^k \frac{n_j}{n}=\sum_{j=0}^k p_r\left(r_j\right) \quad 0 \leq r_j \leq 1 \quad k=0,1, \Lambda, l-1
$$
其反变换式为
$$
r_k=T^{-1}\left(s_k\right)
$$
表4-1 64×64大小的图像灰度分布表

处理过程如下： 由式（4-10）可得到变换函数
$$
\begin{aligned}
& s_0=T\left(r_0\right)=\sum_{j=0}^0 P_r\left(r_j\right)=P_r\left(r_0\right)=0.19 \\
& s_1=T\left(r_1\right)=\sum_{j=0}^1 P_r\left(r_j\right)=P_r\left(r_0\right)+P_r\left(r_1\right)=0.44 \\
& S_2=T\left(r_2\right)=\sum_{j=0}^2 P_r\left(r_j\right)=P_r\left(r_0\right)+P_r\left(r_1\right)+P_r\left(r_2\right)=0.65 \\
& S_3=T\left(r_3\right)=\sum^3 P_r\left(r_j\right)=P_r\left(r_0\right)+P_r\left(r_1\right)+P_r\left(r_2\right)+P_r\left(r_3\right)=0.81
\end{aligned}
$$
依此类推：$S_4=0.89, \quad s 5=0.95, \quad \mathrm{~s}_6=0.98, \quad \mathrm{~s}_7=1.0$ 。

变换函数如图4-10(b)所示。

这里只对图像取8个等间隔的灰度级， 变换后的值也只能选择最靠近的一个灰度级的值。因此，对上述计算值加以修正：
$$
\begin{aligned}
& s_0 \approx \frac{1}{7}, \quad s_1 \approx \frac{3}{7}, \quad s_2 \approx \frac{5}{7}, \quad s_3 \approx \frac{6}{7} \\
& s_4 \approx \frac{6}{7}, \quad s_5 \approx 1, \quad s_6 \approx 1, \quad s_7 \approx 1
\end{aligned}
$$
由上述数值可见，新图像将只有5个不同的灰度级别，可以 重新定义如下一组符号
$$
s_0^{\prime}=\frac{1}{7}, s_1^{\prime}=\frac{3}{7}, s_2^{\prime}=\frac{5}{7}, s_3^{\prime}=\frac{6}{7}, s_4^{\prime}=\frac{6}{7}
$$
因为 $r_0=0$, 经变换得 $s_0=1 / 7$, 所以有 790 个像素取 $s_0$ 这个灰度值。 $r_1$ 映射到 $s_1=3 / 7$, 所以有 1023 个像素取 $s_1=3 / 7$ 这一灰度值。依次类推, 有 850 个像素取 $s_2=5 / 7$ 这个灰度值。但是, 因为 $r_3$ 和 $r_4$ 均映射到 $s_3=6 / 7$ 这一灰度级, 所以有 $656+329=985$ 个像素取这个值。同样, 有 $245+122+81=448$ 个像素取 $s_4=1$ 这个新灰度值。用 $n=4096$ 来除上 述这些 $n_k$ 值, 便可得到新的直方图, 如图4-10(c)所示。

由上例可见，利用累积分布函数作为灰度变换函数，经变换 后得到的新直方图虽然不很平坦，但毕竟比原始图像的直方图平 坦的多， 而且其动态范围也大大地扩展了。因此，这种方法对于 对比度较弱的图像进行处理是很有效的。图4-11是经直方图均衡 化后的Lena图像和其直方图。 因为直方图是近似的概率密度函数，所以用离散灰度级作变 换一般得不到完全平坦的结果。另外，从上例可以看出，变换后 的灰度级减少了，这种现象叫做“简并”现象。由于简并现象的 存在，处理后的灰度级总是要减少的， 这是像素灰度有限的必然 结果。由于上述原因， 数字图像的直方图均衡只是近似的

直方图均衡化

####  期望输出图像概率密度函数是均匀分布的

$$
\begin{aligned}
& P_g(g)=\frac{1}{g_{\text {max }}-g_{\text {min }}}, g_{\text {min }} \leq g \leq g_{\text {max }}, \\
& \int_{g_{\text {min }}}^g \frac{1}{g_{\text {max }}-g_{\text {min }}} d \omega=C(f), \\
& \frac{1}{g_{\text {max }}-g_{\text {min }}}\left(g-g_{\text {min }}\right)=C(f), \\
& g=\left[g_{\text {max }}-g_{\text {min }}\right] C(f)+g_{\text {min }}
\end{aligned}
$$

#### <font color="pink">直方图均衡化算法：</font>

1. 列出原始图像灰度级 $f_j, j=0,1, \ldots, k, \ldots, L-1$;
2. 统计各灰度级的象素数目 $, n_j, j=0,1,, \ldots, k, \ldots, L-1$;
3. 计算原始图像直方图 $P_f\left(f_j\right)=n_j / n, n$ 为原始图像总的象素数目;
4. 计算累积分布函数 $c(f) ; \quad c(f)=\sum_{j=0}^m P_g\left(g_i\right), i=0,1, \ldots, m, \ldots, L-1$ 5.应用转移函数, 计算映射后的灰度级,
$$
g_i=I N T\left[\left(g_{\max }-g_{\text {min }}\right) c(f)+g_{\min }+0.5\right]
$$
**0.5是为了取整后达到四舍五入的效果**

6. 统计映射后各灰度级的象素数目 $n_i, i=0,1, \ldots, p-1$;
7. 计算输出图像直方图 $P_g\left(g_i\right)=n_j / n, i=0,1, \ldots, p-1$;
8. 用 $f_j$ 和 $g_i$ 的映射关系, 修改原始图像灰度级, 获得直方图近似均匀分布 的输出图像。

典型直方图变换的转移函数

## 4.2 灰度变换

### 4.2.1 灰度线性变换

假定原图像 $f(x, y)$ 的灰度范围为 $[a, b]$, 希望变换后图像 $g(x$, $y)$ 的灰度范围扩展至 $[c, d]$, 则线性变换可表示为
$$
g(x, y)=\frac{d-c}{b-a}[f(x, y)-a]+c
$$
此式用图4-12表示。若图像灰度在 $0 \sim M_f$ 范围内, 其中大部分像 素的灰度级分布在区间 $[\mathrm{a}, \mathrm{b}]$, 很小部分的灰度级超出了此区 间, 为改善增强的效果, 可令:
$$
g(x, y)= \begin{cases}c & 0 \leq f(x, y)<a \\ \dfrac{d-c}{b-a}[f(x, y)-a]+c & a \leq f(x, y)<b \\ d & b \leq f(x, y)<M_f\end{cases}
$$
有时为了保持f(x, y)灰度低端和高端值不变，可以采用如式 (4-14)所示的形式
$$
g(x, y)=\left\{\begin{array}{l}
\dfrac{d-c}{b-a}[f(x, y)-a]+c \quad a \leq f(x, y) \leq b \\
f(x, y)
\end{array}\right.
$$
式中的a、 b、 c、 d这些分割点可根据用户的不同需要来确定。

图4-13 线性灰度变换

线性灰度变换效果比较

### 4.2.2 分段线性变换

为了突出感兴趣的目标或灰度区间，相对抑制那些不感兴 趣的灰度区域，可采用分段线性变换。常用的三段线性变换法 如图4-14所示，其数学表达式如下：
$$
g(x, y)= \begin{cases}\frac{c}{a} f(x, y) & 0 \leq f(x, y)<a \\ \frac{d-c}{d-a}[f(x, y)-a]+c & 0 \leq f(x, y)<b \\ \frac{M_g-d}{M_f-b}[f(x, y)-b]+d & b \leq f(x, y)<M_f\end{cases}
$$
式(4-16)对灰度区间 ［0, a］和［b, $M_f$］加以压缩，对灰度 区间［a, b］进行扩展。通过细心调整折线拐点的位置及控制分 段直线的斜率，可对任一灰度区间进行扩展或压缩。这种变换适 用于在黑色或白色附近有噪声干扰的情况。例如, 照片中的划痕， 由于变换后在［0, a］以及［b, $M_f$ ］之间的灰度受到压缩， 因而使污斑得到减弱。

### 4.2.3 非线性变换

S型函数

指数变换

显示器校正

图6-23 不同的s=cr曲线及图像变换结果

组合灰度变换效果与直方图变 图像增强与平滑 化

## 4.3 图像噪声

重点：均值滤波法s

### 4.3.1 概述

噪声可以理解为“妨碍人们感觉器官对所接收的信源信息理解 的因素” 。例如，一幅黑白图像，其亮度分布假定为f (x, y)， 那 么对其起干扰作用的亮度分布R(x, y)便称为图像噪声。噪声在理 论上可以定义为“不可预测， 只能用概率统计方法来认识的随 机误差” 。因此，将图像噪声看成是多维随机过程是合适的， 描述噪声的方法完全可以借用随机过程及其概率分布函数和概 率密度函数。但在很多情况下，这种描述方法很复杂，甚至不 可能，而且实际应用往往也不必要，通常是用其数字特征，即 均值方差、相关函数等进行处理。

目前，大多数数字图像系统中，输入光图像都是采用先冻结 再扫描方式将多维图像变成一维电信号，再对其进行处理、存储、 传输等加工，最后往往还要再组成多维图像信号。图像噪声同样 也受到这样的分解和合成，在这些过程中电气系统和外界影响将 使得图像噪声的精确分析变得十分复杂。另一方面， 对图像信息 的认识和理解是由人的视觉系统所决定的。不同的图像噪声，人 的感觉（理解）程度是不同的，这就是所谓人的噪声视觉特性问 题。该方面虽早已进行研究，但终因人的视觉系统本身未搞清楚 而未获得解决。尽管如此，图像噪声在数字图像处理技术中的重 要性却愈加明显。例如，高放大倍数遥感图片的判读，X射线图 像系统中的噪声去除等都已成为不可缺少的技术。

### 4.3.2 图像噪声分类

图像噪声按其产生的原因可分为外部噪声和内部噪声。 

外部噪声是指系统外部干扰从电磁波或经电源传进系统内 部而引起的噪声，如电气设备、天体放电现象等引起的噪声。 主要外部干扰如下： 

（1） 由光和电的基本性质所引起的噪声。 

（2） 电器的机械运动产生的噪声。如, 各种接头因抖动引起 的电流变化所产生的噪声；磁头、磁带抖动引起的抖动噪声等。

（3） 元器件材料本身引起的噪声。如, 磁带、 磁盘表面缺陷 所产生的噪声。 

（4） 系统内部设备电路所引起的噪声。如, 电源系统引入的 交流噪声，偏转系统和箝位电路引起的噪声等。 

图像噪声从统计特性可分为平稳噪声和非平稳噪声两种。 统计特性不随时间变化的噪声称为平稳噪声；统计特性随时间 变化的噪声称为非平稳噪声

另外, 按噪声和信号之间的关系可分为加性噪声和乘性噪 声。假定信号为 $S(t)$, 噪声为 $n(t)$, 如果混合叠加波形是 $S(t)+n(t)$ 形式, 则称其为加性噪声; 如果叠加波形为 $S(t)[1+n(t)]$ 形式, 则称其为乘性噪声。为了分析处理方便, 往往将乘性噪声近似 认为加性噪声, 而且总是假定信号和噪声是互相独立的。

### 4.3.3 图像系统噪声特点

如图4-16是一幅含有噪声的图像， 由此可知图像中的噪声 有以下三个特点。

1. 噪声在图像中的分布和大小不规则
2. 噪声与图像之间具有相关性
3. 噪声具有叠加性

图4-16 有噪声的图像

## 4.4 去除噪声

改善降质图像的方法有两类：

一类是不考虑图像降质的原因， 只将图像中感兴趣的部分加以处理或突出有用的图像特征，故改 善后的图像并不一定要去逼近原图像。这一类图像改善方法称为 图像增强，主要目的是要提高图像的可懂度。

> 通过图像增强的方法提高图像质量，这一类方法称之为黑盒子办法.不去了解内部机理,只研究输入和输出

另一类方法是针对 图像降质的具体原因，设法补偿降质因素，使改善后的图像尽可 能地逼近原始图像。这类方法称为图像恢复或图像复原技术

图像增强处理的方法基本上可分为空间域法和频率法两大 类。前者是在原图像上直接进行数据运算，对像素的灰度值进 行处理。它又分为两类，一类是对图像作逐点运算，称为点运 算；另一类是在与处理像点邻域有关的空间域上进行运算， 称 为局部运算。频域法是在图像的变换域上进行处理， 增强感兴 趣的频率分量， 然后进行反变换， 得到增强了的图像

> 图像恢复则被称之为白盒子办法,需要了解内部机理

### 4.4.1 模板操作和卷积运算

<font color="pink">超重点:模板匹配法,掌握则保证85分s</font>

模板操作(前提:空域)是数字图像处理中常用的一种运算方式，图像的平 滑、锐化以及后面将要讨论的细化、边缘检测等都要用到模板操 作。例如， 有一种常见的平滑算法是将原图中的一个像素的灰度 值和它周围邻近8个像素的灰度值相加，然后将求得的平均值作 为新图像中该像素的灰度值。可用如下方法来表示该操作：
$$
\frac{1}{9}\left[\begin{array}{ccc}
1 & 1 & 1 \\
1 & 1 * & 1 \\
1 & 1 & 1
\end{array}\right]
$$

> 星号是代替的意思

上式有点类似于矩阵，通常称之为模板（Template），带星 号的数据表示该元素为中心元素，即这个元素是将要处理的元 素。如果模板为
$$
\frac{1}{9}\left[\begin{array}{ccc}
1 * & 1 & 1 \\
1 & 1 * & 1 \\
1 & 1 & 1
\end{array}\right]
$$
则该操作的含义是：将原图中一个像素的灰度值和它右下相 邻近的8个像素值相加，然后将求得的平均值作为新图像中该像 素的灰度值

模板操作实现了一种邻域运算，即某个像素点的结果不仅和 本像素灰度有关，而且和其邻域点的值有关。模板运算的数学含 义是卷积（或互相关）运算。 卷积是一种用途很广的算法，可用卷积来完成各种处理变换， 图4-17说明了卷积的处理过程