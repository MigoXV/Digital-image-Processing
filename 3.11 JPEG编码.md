# 3.11  JPEG 编码

## 3.11 JPEG基本系统编码

​        JPEG是面向静态图像编码的国际标准。在相同图像质量条件下， JPEG文件拥有比其他图像文件格式更高的压缩比。JPEG目前被广泛应用于多媒体和网络程序中，是现今万维网中使用最广泛的两种图像文件格式之一。JPEG是一种有损压缩， 即在压缩过程中会丢失数据，每次编辑JPEG图像后，图像就会被重复压缩一次， 损失就会有所增加。

        JPEG允许四种编码模式： 
     （1） 顺序式（Sequential）DCT方式：从左到右、从上到下对图像顺序进行基于离散余弦变换（DCT）的编码。DCT理论上是可逆的，但在计算时存在误差，因而基于DCT的编码模式是一种有损编码。 

      （2） 渐进式（Progressive）DCT方式：基于DCT，对图像分层次进行处理，从模糊到清晰地传输图像（与GIF文件的交错方式类似）。有两种实现方法，一种是频谱选择法，即按Z形扫描的序号将DCT量化序数分成几个频段，每个频段对应一次扫描， 每块均先传送低频扫描数据，得到原图概貌，再依次传送高频扫描数据，使图像逐渐清晰；另一种是逐次逼近法，即每次扫描全部DCT量化序数，但每次的表示精度逐渐提高。
      （3） 无失真（Lossless）方式： 使用线性预测器，如DPCM， 而不是基于DCT。 

      （4） 分层（Hierarchical）方式： 在空间域将源图像以不同的分辨率表示，每个分辨率对应一次扫描， 处理时可以基于DCT或预测编码，可以是渐进式，也可以是顺序式。
        JPEG定义了三种系统：基本系统（Baseline System）、扩展系统（Extended System）和无失真压缩系统（Lossless System）。一个符合JPEG标准的编解码器至少要满足基本系统的技术指标。
        基本的JPEG算法属于变换类编码，下面针对基于DCT的顺序式基本系统编码来说明JPEG的编码方法。 

![image-20230419203131892](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203131892.png)

图3-3 JPEG 编码流程图

1) 数据分块
对图像进行编码前, 将每个分量图像分割成不重叠的 $8 \times 8$ 像素块, 每一个 $8 \times 8$ 像素块称为一个数据单元 (DU)。在彩 色图像中, JPEG分别压缩图像的每个彩色分量。虽然JPEG可 以压缩通常的红绿蓝分量, 但在 $Y_{b} C_{r}$ 空间的压缩效果会更好。 这是因为人眼对色彩的变化不如对亮度的变化敏感, 因而对色 彩的编码可以比对亮度的编码粗糙些, 这主要体现在不同的采 样频率和量化精度上。因此, 编码前一般先将图像从RGB空间 转换到 $YC_{b} C_{i}$ 空间，再把各分量图像分割成 $8 \times 8$ 数据块。

在对图像采样时, 可以采用不同的采样频率, 这种技术称 为二次采样。由于亮度比色彩更重要, 因而对 $Y$ 分量的采样频 率可高于对 $C_{b} 、 C_{r}$ 的采样频率, 这样有利于节省存储空间。常 用的采样方案有YUV422和YUV411。把采样频率最低的分量图 像中一个DU所对应的像区上覆盖的所有各分量上的DU按顺序 编组为一个最小编码单元 (MCU）。对灰度图像而言, 只有一 个Y分量, MCU就是一个数据单元。而对彩色图像而言, 以 4:1:1的采样方案为例, 则一个MCU由4个 4 分量的DU、 1 个 $C_{b}$ 分 量的DU和1个 $C_{r}$ 分量的DU组成。

2) DCT处理
图像数据块分割后, 即以 MCU为单位顺序将DU进行二维 离散余弦变换。对以无符号数表示的具有 $P$ 位精度的输入数据, 在DCT前要减去 $2^{P-1}$, 转换成有符号数, 而在IDCT后, 应加上 $2^{P-1}$, 转换成无符号数。对每个 $8 \times 8$ 的数据块 $DU$ 进行 $DCT$ 后, 得到的64个系数代表了该图像块的频率成分，其中低频分量集 中在左上角, 高频分量分布在右下角。系数矩阵左上角的叫做 直流（DC）系数，它代表了该数据块的平均值, 其余 63 个叫交 流（AC）系数。

        3） 系数量化
        在DCT处理中得到的64个系数中，低频分量包含了图像亮度等主要信息。在从空间域到频域的变换中，图像中的缓慢变化比快速变化更易引起人眼的注意， 所以在重建图像时，低频分量的重要性高于高频分量。因而在编码时可以忽略高频分量， 从而达到压缩的目的，这也是量化的根据和目的。 

​        在JPEG标准中，用具有64个独立元素的量化表来规定DCT域中相应的64个系数的量化精度，使得对某个系数的具体量化阶取决于人眼对该频率分量的视觉敏感程度。理论上，对不同的空间分辨率、数据精度等情况，应该有不同的量化表。不过，一般采用图3-4和图3-5所示的量化表，可取得较好的视觉效果。之所以用两张量化表，是因为Y分量比Cb和Cr更重要些，因而对Y采用细量化，而对Cb和Cr采用粗量化。量化就是用DCT变换后的系数除以量化表中相对应的量化阶后四舍五入取整。由于量化表中左上角的值较小，而右下角的值较大， 因而起到了保持低频分量、 抑制高频分量的作用。 

![image-20230419203258219](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203258219.png)

图3-4 亮度量化表

![image-20230419203308344](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203308344.png)

图3-5 色度量化表

        4） Z形扫描
        DCT系数量化后，构成一个稀疏矩阵，用Z（Zigzag）形扫描将其变成一维数列，将有利于熵编码。Z形扫描的顺序如图3-6所示。 

![image-20230419203321662](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203321662.png)

图3-6 DCT系数的Z形扫描顺序

​    5） DC系数编码

​    DC系数反映了一个8×8数据块的平均亮度，一般与相邻块有较大的相关性。JPEG对DC系数作差分编码，即用前一数据块的同一分量的DC系数作为当前块的预测值，再对当前块的实际值与预测值的差值作哈夫曼编码。

​    若DC系数的动态范围为-1024～+1024，则差值的动态范围为-2047～+2047。如果为每个差值赋予一个码字， 则码表过于庞大。因此，JPEG对码表进行了简化，采用“前缀码（SSSS）+尾码”来表示。前缀码指明了尾码的有效位数B， 可以根据DIFF从表3-8中查出前缀码对应的哈夫曼编码。尾码的取值取决于DC系数的差值和前缀码。如果DC系数的差值DIFF大于等于0，则尾码的码字为DIFF的B位原码；否则，取DIFF的B位反码。 

表3-8 图像分量为8位时DC系数差值的典型哈夫曼编码表 

![image-20230419203426825](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203426825.png)

       6） AC系数编码
       经Z形排列后的AC系数，更有可能出现连续0组成的字符串， 从而对其进行行程编码将有利于压缩数据。JPEG将一个非零DC系数及其前面的0行程长度（连续0的个数）的组合称为一个事件。将每个事件编码表示为“NNNN/SSSS+尾码”， 其中， NNNN为0行程的长度，SSSS表示尾码的有效位数B（即当前非0系数所占的比特数），如果非零AC系数大于等于0， 则尾码的码字为该系数的B位原码， 否则， 取该系数的B位反码。
       由于只用4位表示0行程的长度，故在JPEG编码中，最大0行程只能等于15。当0行程长度大于16时，需要将其分开多次编码， 即对前面的每16个0以“F/0”表示，对剩余的继续编码。 

表3-9 AC系数的尾码位数表 

| SSSS | AC系数的尾码位数表   |
| ---- | -------------------- |
| 0    | 0                    |
| 1    | -1,1                 |
| 2    | -3, -2, 2, 3         |
| 3    | -7~-4, 4~7           |
| 4    | -15~-8, 8~15         |
| 5    | -31~-16, 16~31       |
| 6    | -63~-17, 17~63       |
| 7    | -127~-64, 64~127     |
| 8    | -255~-128, 128~255   |
| 9    | -511~256, 256~511    |
| 10   | -1023~-512, 512~1023 |

表3-10 亮度AC系数码表 

![image-20230419203504472](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203504472.png)

![image-20230419203515866](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203515866.png)

![](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203515866.png)

表3-11 色差AC系数编码 

![image-20230419203536714](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203536714.png)

![](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203536714.png)

![](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203536714.png)

3.11.2 JPEG编码实例
       下面结合一个实例来讲述JPEG基本系统的编码过程。设有一图像亮度数据块如图3-7所示，对其进行离散余弦变换后， 用图3-4所示的亮度量化表对系数矩阵量化后的结果如图3-8所示。对量化结果按图3-6所示的顺序进行Z形扫描， 并对扫描结果的DC及AC系数进行编码的结果见表3-12。由于数据较多， 为简便起见， 这里只对几个系数的编码加以说明。 

![image-20230419203603903](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203603903.png)

图3-7 源图像亮度数据块

![image-20230419203617741](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203617741.png)

图3-8 量化结果

表3-12 Zigzag排列及行程编码与哈夫曼编码（VLC）结果 

![image-20230419203647296](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203647296.png)

表3-12 Zigzag排列及行程编码与哈夫曼编码（VLC）结果 

![image-20230419203658730](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203658730.png)

       1） DC系数的编码
       在量化系数矩阵的Z形扫描结果中，第一个系数为DC系数。假设前一亮度数据块的DC系数为40， 则差值DIFF=44-40=4， 因4在（-7~-4， 4~7）范围内， 由表3-8查得SSSS=3，其前缀码字为“100”， 3位尾码即为4的二进制原码“100”， 从而DC系数的编码为“100100”。如果前一数据块的DC系数为48， 则DIFF=-4， 由表10-8查得SSSS及前缀码字同上，其3位尾码即-4的反码“011”， 因此DC系数的编码为“100011”。解码时， 由前缀码“100”可知尾码有3位，若前缀码字是“100”， 因其最高位为1，故可得DC系数的差值为4； 若前缀码字为“011”，因最高位为0，知其为负， 故取反后可得差值为-4。 

        2） AC系数的编码
        在Z形扫描结果中，第一个非零AC系数为10。在它前面的连零个数为1， 即NNNN=1。根据AC系数10从表3-9查得SSSS=4， 由NNNN/SSSS=1/4从表3-10查得其哈夫曼码字为“111110110”， 而10的二进制码为“1010”， 因此该AC系数的编码为“1111101101010”。由于篇幅所限，其他AC系数的编码就不再赘述， 结果见表10-12。在Z形扫描结果中的末尾，除第54个系数非零外， 其他系数全为零， 故直接用一个结束块“EOB（0/0）”结束本块，由表3-10查得其码字为“1010”。于是，最后该亮度块的编码为（其中，假定差值为4）100100111110110101001100111110000101010001001101100100010011101010000110001010000110001111000000000001000111000110001100100000111001001001111001000001111001111101111010，共用了168位，而原始图像块需8×8×8＝512位，因此压缩比为3.048。 

JPEG压缩编码示例

![image-20230419203739140](https://mypic-1312707183.cos.ap-nanjing.myqcloud.com/image-20230419203739140.png)